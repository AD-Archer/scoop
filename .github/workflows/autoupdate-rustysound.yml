name: Auto-update rustysound manifest

on:
  workflow_dispatch:
  repository_dispatch:
    types:
      - rustysound-release

permissions:
  contents: write

concurrency:
  group: rustysound-autoupdate
  cancel-in-progress: true

jobs:
  autoupdate:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Scoop
        shell: pwsh
        run: |
          Set-ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
          Invoke-RestMethod -Uri https://get.scoop.sh | Invoke-Expression
          "$env:USERPROFILE\scoop\shims" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          "$env:USERPROFILE\scoop\apps\scoop\current\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Verify Scoop on PATH
        shell: pwsh
        run: |
          scoop --version

      - name: Resolve target release from dispatch
        id: target
        shell: pwsh
        run: |
          $eventName = '${{ github.event_name }}'
          $raw = '${{ github.event.client_payload.version }}'
          if ($eventName -eq 'repository_dispatch' -and -not [string]::IsNullOrWhiteSpace($raw)) {
            if ($raw.StartsWith('v')) {
              $tag = $raw
              $version = $raw.Substring(1)
            } else {
              $tag = "v$raw"
              $version = $raw
            }
            "has_target=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            "has_target=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          }

      - name: Update manifest from dispatched release
        if: steps.target.outputs.has_target == 'true'
        shell: pwsh
        run: |
          $tag = '${{ steps.target.outputs.tag }}'
          $version = '${{ steps.target.outputs.version }}'

          $release = Invoke-RestMethod -Uri "https://api.github.com/repos/AD-Archer/RustySound/releases/tags/$tag" -Headers @{ Accept = 'application/vnd.github+json' }

          $assetName = "Rustysound_${version}_x64-setup.exe"
          $asset = $release.assets | Where-Object { $_.name -eq $assetName } | Select-Object -First 1
          if (-not $asset) {
            throw "Could not find release asset '$assetName' for tag $tag"
          }

          $tmpFile = Join-Path $env:RUNNER_TEMP $assetName
          Invoke-WebRequest -Uri $asset.browser_download_url -OutFile $tmpFile
          $hash = (Get-FileHash -Algorithm SHA256 -Path $tmpFile).Hash.ToLower()

          $manifestPath = Join-Path $env:GITHUB_WORKSPACE 'bucket/rustysound.json'
          $manifest = Get-Content $manifestPath -Raw | ConvertFrom-Json
          $manifest.version = $version
          $manifest.architecture.'64bit'.url = "https://github.com/AD-Archer/RustySound/releases/download/$tag/$assetName#/dl.7z"
          $manifest.architecture.'64bit'.hash = $hash
          $manifest | ConvertTo-Json -Depth 20 | Set-Content -Path $manifestPath -Encoding utf8

      - name: Update manifest with checkver
        if: steps.target.outputs.has_target != 'true'
        shell: pwsh
        run: |
          & "$env:USERPROFILE\scoop\apps\scoop\current\bin\checkver.ps1" -u -Dir "$env:GITHUB_WORKSPACE\bucket" rustysound

      - name: Detect manifest changes
        id: changes
        shell: pwsh
        run: |
          $changed = git status --porcelain -- bucket/rustysound.json
          if ([string]::IsNullOrWhiteSpace($changed)) {
            "updated=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            $version = (Get-Content bucket/rustysound.json -Raw | ConvertFrom-Json).version
            "updated=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          }

      - name: Smoke test install
        if: steps.changes.outputs.updated == 'true'
        shell: pwsh
        run: |
          scoop install .\bucket\rustysound.json
          scoop uninstall rustysound

      - name: Commit and push
        if: steps.changes.outputs.updated == 'true'
        shell: pwsh
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add bucket/rustysound.json
          git commit -m "rustysound: update to ${{ steps.changes.outputs.version }}"
          git push
