name: Auto-update rustysound manifest

on:
  workflow_dispatch:
  repository_dispatch:
    types:
      - rustysound-release

permissions:
  contents: write

concurrency:
  group: rustysound-autoupdate
  cancel-in-progress: true

jobs:
  autoupdate:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Scoop
        shell: pwsh
        run: |
          Set-ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
          Invoke-RestMethod -Uri https://get.scoop.sh | Invoke-Expression
          "$env:USERPROFILE\scoop\shims" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          "$env:USERPROFILE\scoop\apps\scoop\current\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Verify Scoop on PATH
        shell: pwsh
        run: |
          scoop --version

      - name: Update manifest with checkver
        shell: pwsh
        run: |
          & "$env:USERPROFILE\scoop\apps\scoop\current\bin\checkver.ps1" -u -Dir "$env:GITHUB_WORKSPACE\bucket" rustysound

      - name: Detect manifest changes
        id: changes
        shell: pwsh
        run: |
          $changed = git status --porcelain -- bucket/rustysound.json
          if ([string]::IsNullOrWhiteSpace($changed)) {
            "updated=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            $version = (Get-Content bucket/rustysound.json -Raw | ConvertFrom-Json).version
            "updated=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          }

      - name: Smoke test install
        if: steps.changes.outputs.updated == 'true'
        shell: pwsh
        run: |
          scoop install .\bucket\rustysound.json
          scoop uninstall rustysound

      - name: Commit and push
        if: steps.changes.outputs.updated == 'true'
        shell: pwsh
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add bucket/rustysound.json
          git commit -m "rustysound: update to ${{ steps.changes.outputs.version }}"
          git push
